var variables=[],variableType=0;function changeType(e){"simple"==(variableType=e.value)?(document.getElementById("field").style.display="block",document.getElementById("field").required=!0,document.getElementById("fieldLabel").style.display="block"):(document.getElementById("field").style.display="none",document.getElementById("field").required=!1,document.getElementById("fieldLabel").style.display="none",document.getElementById("field").value="")}function save(e){var t=[];$.each($("#conditionsTable").DataTable().rows().data(),function(e,a){t.push({condition:unescapeHtml(a[0]),value:unescapeHtml(a[1])})});var a={name:$("#name").val(),type:$("input[name=type]:checked").val(),field:$("#field").val(),conditions:t};-1!=e?(a.id=e,api.variableId.put(a).success(function(e){successFlash("Variable updated successfully!"),load(),dismiss(),$("#modal").modal("hide")}).error(function(e){modalError(e.responseJSON.message)})):api.variables.post(a).success(function(e){successFlash("Variable added successfully!"),load(),dismiss(),$("#modal").modal("hide")}).error(function(e){modalError(e.responseJSON.message)})}function dismiss(){$("#conditionsTable").dataTable().DataTable().clear().draw(),$("#name").val(""),$("#modal\\.flashes").empty()}function edit(e){if(conditions=$("#conditionsTable").dataTable({destroy:!0,columnDefs:[{orderable:!1,targets:"no-sort"}]}),$("#modalSubmit").unbind("click").click(function(){save(e)}),-1==e);else api.variableId.get(e).success(function(e){""==e.field&&(document.getElementById("field").style.display="none",document.getElementById("field").required=!1,document.getElementById("fieldLabel").style.display="none",document.getElementById("simple").checked=!1,document.getElementById("complex").checked=!0),$("#name").val(e.name),$("#field").val(e.field),$.each(e.conditions,function(e,a){conditions.DataTable().row.add([escapeHtml(a.condition),escapeHtml(a.value),'<span style="cursor:pointer;"><i class="fa fa-trash-o"></i></span>']).draw()})}).error(function(){errorFlash("Error fetching variable")});$("#csvconditionsupload").fileupload({url:"/api/import/variable",dataType:"json",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+user.api_key)},add:function(e,a){$("#modal\\.flashes").empty();var t=a.originalFiles[0].name;if(t&&!/(csv|txt)$/i.test(t.split(".").pop()))return modalError("Unsupported file extension (use .csv or .txt)"),!1;a.submit()},done:function(e,a){$.each(a.result,function(e,a){addCondition(a.condition,a.value)}),conditions.DataTable().draw()}})}var downloadCSVTemplate=function(){var e="variable_template.csv",a=Papa.unparse([{Condition:"Example",Value:"Example Text"}],{}),t=new Blob([a],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(t,e);else{var n=window.URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.setAttribute("download",e),document.body.appendChild(i),i.click(),document.body.removeChild(i)}},deleteVariable=function(n){var e=variables.find(function(e){return e.id===n});e&&Swal.fire({title:"Are you sure?",text:"This will delete the variable. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete "+escapeHtml(e.name),confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise(function(a,t){api.variableId.delete(n).success(function(e){a()}).error(function(e){t(e.responseJSON.message)})})}}).then(function(e){e.value&&Swal.fire("Variable Deleted!","This variable has been deleted!","success"),$('button:contains("OK")').on("click",function(){location.reload()})})};function addCondition(e,a){var t=[escapeHtml(e),escapeHtml(a),'<span style="cursor:pointer;"><i class="fa fa-trash-o"></i></span>'],n=conditions.DataTable(),i=n.column(0,{order:"index"}).data().indexOf(condition);0<=i?n.row(i,{order:"index"}).data(t):n.row.add(t)}function load(){$("#variableTable").hide(),$("#emptyMessage").hide(),$("#loading").show(),api.variables.summary().success(function(e){if($("#loading").hide(),0<e.total){variables=e.variables,$("#emptyMessage").hide(),$("#variableTable").show();var t=$("#variableTable").DataTable({destroy:!0,columnDefs:[{orderable:!1,targets:"no-sort"}]});t.clear(),$.each(variables,function(e,a){t.row.add([escapeHtml(a.name),escapeHtml(a.field),escapeHtml(a.num_conditions),moment(a.modified_date).format("MMMM Do YYYY, h:mm:ss a"),"<div class='pull-right'><button class='btn btn-primary' data-toggle='modal' data-backdrop='static' data-target='#modal' onclick='edit("+a.id+")'>                    <i class='fa fa-pencil'></i>                    </button>                    <button class='btn btn-danger' onclick='deleteVariable("+a.id+")'>                    <i class='fa fa-trash-o'></i>                    </button></div>"]).draw()})}else $("#emptyMessage").show()}).error(function(){errorFlash("Error fetching variables")})}$(document).ready(function(){load(),$("#conditionForm").submit(function(){var e=document.getElementById("conditionForm");if(e.checkValidity())return addCondition($("#condition").val(),$("#value").val()),conditions.DataTable().draw(),$("#conditionForm>div>input").val(""),$("#condition").focus(),!1;e.reportValidity()}),$("#conditionsTable").on("click","span>i.fa-trash-o",function(){conditions.DataTable().row($(this).parents("tr")).remove().draw()}),$("#modal").on("hide.bs.modal",function(){dismiss()}),$("#csv-template").click(downloadCSVTemplate)});