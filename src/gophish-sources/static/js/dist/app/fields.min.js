var fields=[];function save(e){var t=[];$.each($("#valuesTable").DataTable().rows().data(),function(e,a){t.push({email:unescapeHtml(a[0]),value:unescapeHtml(a[1])})});var a={name:$("#name").val(),values:t};-1!=e?(a.id=e,api.fieldId.put(a).success(function(e){successFlash("Field updated successfully!"),load(),dismiss(),$("#modal").modal("hide")}).error(function(e){modalError(e.responseJSON.message)})):api.fields.post(a).success(function(e){successFlash("Field added successfully!"),load(),dismiss(),$("#modal").modal("hide")}).error(function(e){modalError(e.responseJSON.message)})}function dismiss(){$("#valuesTable").dataTable().DataTable().clear().draw(),$("#name").val(""),$("#modal\\.flashes").empty()}function edit(e){if(values=$("#valuesTable").dataTable({destroy:!0,columnDefs:[{orderable:!1,targets:"no-sort"}]}),$("#modalSubmit").unbind("click").click(function(){save(e)}),-1==e);else api.fieldId.get(e).success(function(e){$("#name").val(e.name),$.each(e.values,function(e,a){values.DataTable().row.add([escapeHtml(a.email),escapeHtml(a.value),'<span style="cursor:pointer;"><i class="fa fa-trash-o"></i></span>']).draw()})}).error(function(){errorFlash("Error fetching field")});$("#csvvaluesupload").fileupload({url:"/api/import/field",dataType:"json",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+user.api_key)},add:function(e,a){$("#modal\\.flashes").empty();var t=a.originalFiles[0].name;if(t&&!/(csv|txt)$/i.test(t.split(".").pop()))return modalError("Unsupported file extension (use .csv or .txt)"),!1;a.submit()},done:function(e,a){$.each(a.result,function(e,a){addValue(a.email,a.value)}),values.DataTable().draw()}})}var downloadCSVTemplate=function(){var e="field_template.csv",a=Papa.unparse([{Email:"foobar@example.com",Value:"Example"}],{}),t=new Blob([a],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(t,e);else{var l=window.URL.createObjectURL(t),s=document.createElement("a");s.href=l,s.setAttribute("download",e),document.body.appendChild(s),s.click(),document.body.removeChild(s)}},deleteField=function(l){var e=fields.find(function(e){return e.id===l});e&&Swal.fire({title:"Are you sure?",text:"This will delete the field. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete "+escapeHtml(e.name),confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise(function(a,t){api.fieldId.delete(l).success(function(e){a()}).error(function(e){t(e.responseJSON.message)})})}}).then(function(e){e.value&&Swal.fire("Field Deleted!","This field has been deleted!","success"),$('button:contains("OK")').on("click",function(){location.reload()})})};function addValue(e,a){var t=escapeHtml(e).toLowerCase(),l=[t,escapeHtml(a),'<span style="cursor:pointer;"><i class="fa fa-trash-o"></i></span>'],s=values.DataTable(),o=s.column(0,{order:"index"}).data().indexOf(t);0<=o?s.row(o,{order:"index"}).data(l):s.row.add(l)}function load(){$("#fieldTable").hide(),$("#emptyMessage").hide(),$("#loading").show(),api.fields.summary().success(function(e){if($("#loading").hide(),0<e.total){fields=e.fields,$("#emptyMessage").hide(),$("#fieldTable").show();var t=$("#fieldTable").DataTable({destroy:!0,columnDefs:[{orderable:!1,targets:"no-sort"}]});t.clear(),$.each(fields,function(e,a){t.row.add([escapeHtml(a.name),escapeHtml(a.num_values),moment(a.modified_date).format("MMMM Do YYYY, h:mm:ss a"),"<div class='pull-right'><button class='btn btn-primary' data-toggle='modal' data-backdrop='static' data-target='#modal' onclick='edit("+a.id+")'>                    <i class='fa fa-pencil'></i>                    </button>                    <button class='btn btn-danger' onclick='deleteField("+a.id+")'>                    <i class='fa fa-trash-o'></i>                    </button></div>"]).draw()})}else $("#emptyMessage").show()}).error(function(){errorFlash("Error fetching fields")})}$(document).ready(function(){load(),$("#valueForm").submit(function(){var e=document.getElementById("valueForm");if(e.checkValidity())return addValue($("#email").val(),$("#value").val()),values.DataTable().draw(),$("#valueForm>div>input").val(""),$("#email").focus(),!1;e.reportValidity()}),$("#valuesTable").on("click","span>i.fa-trash-o",function(){values.DataTable().row($(this).parents("tr")).remove().draw()}),$("#modal").on("hide.bs.modal",function(){dismiss()}),$("#csv-template").click(downloadCSVTemplate)});